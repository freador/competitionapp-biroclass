<% content_for :title, @competition.title %>

<%= render "shared/page_header",
    title: @competition.title,
    breadcrumb: "Dashboard da competição",
    subtitle: @competition.description %>

<div class="mt-8 space-y-8">
  <!-- Competition Details Card -->
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-xl">
    <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
      <!-- Status -->
      <div class="rounded-2xl border border-slate-100 bg-gradient-to-br from-indigo-50 to-purple-50 p-4">
        <div class="flex items-center gap-3">
          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
            <svg class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <use href="#heroicon-trophy" />
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Status</p>
            <% status_variant = case @competition.status
                when "active", "ativo", "em_andamento" then "success"
                when "rascunho", "draft" then "warning"
                when "finalizada", "finished" then "default"
                else "info"
              end %>
            <%= render "shared/badge", text: @competition.status, variant: status_variant, size: "md" %>
          </div>
        </div>
      </div>

      <!-- Participants Count -->
      <div class="rounded-2xl border border-slate-100 bg-gradient-to-br from-purple-50 to-pink-50 p-4">
        <div class="flex items-center gap-3">
          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
            <svg class="h-6 w-6 text-purple-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <use href="#heroicon-users" />
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Participantes</p>
            <p class="text-2xl font-bold text-slate-900"><%= @competition.participants.count %></p>
          </div>
        </div>
      </div>

      <!-- Owner Info -->
      <div class="rounded-2xl border border-slate-100 bg-gradient-to-br from-pink-50 to-rose-50 p-4">
        <div class="flex items-center gap-3">
          <div class="flex h-12 w-12 items-center justify-center rounded-full bg-white shadow-sm">
            <svg class="h-6 w-6 text-pink-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <use href="#heroicon-star" />
            </svg>
          </div>
          <div>
            <p class="text-xs font-semibold uppercase tracking-wide text-slate-500">Organizador</p>
            <p class="text-sm font-semibold text-slate-900"><%= @competition.owner.name %></p>
          </div>
        </div>
      </div>
    </div>

    <!-- Rules Section -->
    <% if @competition.rules.present? %>
      <div class="mt-6 rounded-2xl border border-slate-100 bg-slate-50/60 p-6">
        <div class="flex items-center gap-2 mb-3">
          <svg class="h-5 w-5 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <use href="#heroicon-document" />
          </svg>
          <h3 class="text-lg font-semibold text-slate-900">Regras da Competição</h3>
        </div>
        <div class="prose prose-sm max-w-none text-slate-700">
          <%= simple_format(@competition.rules) %>
        </div>
      </div>
    <% end %>

    <!-- Actions -->
    <div class="mt-6 flex flex-wrap gap-3">
      <% if @competition.owner == current_user %>
        <%= link_to edit_competition_path(@competition), class: "inline-flex items-center gap-2 rounded-full border border-slate-300 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-slate-700 transition-all duration-200 hover:bg-slate-50 hover:border-slate-400 active:scale-95" do %>
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <use href="#heroicon-pencil" />
          </svg>
          Editar competição
        <% end %>
        <% if @competition.draft? %>
          <%= button_to start_competition_path(@competition),
              method: :patch,
              disabled: !@competition.ready_to_publish?,
              class: "inline-flex items-center gap-2 rounded-full border border-emerald-200 bg-emerald-50 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-emerald-700 transition-all duration-200 hover:bg-emerald-100 hover:border-emerald-300 active:scale-95 disabled:cursor-not-allowed disabled:opacity-60" do %>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <use href="#heroicon-trophy" />
            </svg>
            Começar competição
          <% end %>
          <% unless @competition.ready_to_publish? %>
            <p class="text-xs text-slate-500">Cadastre ao menos 1 jurado e 1 participante para iniciar.</p>
          <% end %>
        <% elsif @competition.open? %>
          <%= button_to close_competition_path(@competition),
              method: :patch,
              class: "inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-rose-600 transition-all duration-200 hover:bg-rose-100 hover:border-rose-300 active:scale-95" do %>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
              <use href="#heroicon-trash" />
            </svg>
            Encerrar competição
          <% end %>
        <% end %>
      <% end %>
      <%= link_to competitions_path, class: "inline-flex items-center gap-2 rounded-full border border-slate-300 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-slate-700 transition-all duration-200 hover:bg-slate-50 hover:border-slate-400 active:scale-95" do %>
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
          <use href="#heroicon-arrow-right" />
        </svg>
        Voltar para competições
      <% end %>
      <% if @competition.accepted_judge?(current_user) && @competition.open? %>
        <%= link_to "Painel de notas", judging_competition_path(@competition), class: "inline-flex items-center gap-2 rounded-full bg-slate-900 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-white transition-all duration-200 hover:bg-slate-800 active:scale-95" %>
      <% end %>
      <% if @competition.owner == current_user %>
        <%= button_to competition_path(@competition), method: :delete, form: { data: { turbo_confirm: "Tem certeza que deseja excluir esta competição?" } }, class: "inline-flex items-center gap-2 rounded-full border border-rose-200 bg-rose-50 px-5 py-2.5 text-xs font-semibold uppercase tracking-wide text-rose-600 transition-all duration-200 hover:bg-rose-100 hover:border-rose-300 active:scale-95" do %>
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <use href="#heroicon-trash" />
          </svg>
          Excluir competição
        <% end %>
      <% end %>
    </div>
  </article>

  <% if @competition.owner == current_user %>
    <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-xl">
      <header class="flex flex-wrap items-center justify-between gap-4">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-indigo-400">Convites</p>
          <h2 class="text-2xl font-semibold text-slate-900">Links para jurados</h2>
          <p class="text-sm text-slate-500">Compartilhe os links abaixo apenas com o time de avaliação. Participantes não precisam de convite: basta cadastrá-los pelo nome e as notas aparecerão no painel público em tempo real.</p>
        </div>
      </header>

      <section class="mt-6">
        <h3 class="text-sm font-semibold text-slate-700">Jurados</h3>
        <% if @judge_invites&.any? %>
          <ul class="mt-3 space-y-3">
            <% @judge_invites.each do |invite| %>
              <li class="rounded-2xl border border-slate-100 bg-slate-50/80 p-4">
                <p class="font-semibold text-slate-900"><%= invite.email %></p>
                <p class="text-xs text-slate-500">Status: <%= invite.status %></p>
                <div class="mt-2 rounded-xl bg-white/70 px-3 py-2 text-xs font-mono text-slate-600">
                  <%= invite.invitation_path %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="mt-3 text-sm text-slate-500">Nenhum jurado cadastrado nesta competição.</p>
        <% end %>
      </section>
    </article>
  <% end %>

  <!-- Participants Section -->
  <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-xl">
    <header class="flex items-center justify-between mb-6">
      <div>
        <p class="text-xs uppercase tracking-[0.3em] text-indigo-400">Participantes</p>
        <h2 class="text-2xl font-semibold text-slate-900">Lista de Participantes</h2>
      </div>
      <% if @competition.owner == current_user %>
        <%= link_to new_participant_path(competition_id: @competition.id), class: "inline-flex items-center gap-2 rounded-full bg-indigo-600 px-4 py-2.5 text-xs font-semibold uppercase tracking-wide text-white shadow-lg shadow-indigo-500/30 transition-all duration-200 hover:bg-indigo-500 hover:shadow-xl active:scale-95" do %>
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <use href="#heroicon-plus" />
          </svg>
          Adicionar participante
        <% end %>
      <% end %>
    </header>

    <% if @competition.participants.any? %>
      <div class="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
        <% @competition.participants.each do |participant| %>
          <div class="group rounded-2xl border border-slate-100 bg-slate-50/60 p-4 transition-all duration-200 hover:shadow-md hover:border-slate-200 hover:bg-white">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="text-lg font-semibold text-slate-900 group-hover:text-indigo-600 transition-colors"><%= participant.name %></h3>
                <% if participant.user.present? %>
                  <p class="text-xs text-slate-500">Conta vinculada: <%= participant.user.name %></p>
                <% end %>
              </div>
              <%= link_to participant_path(participant), class: "flex h-8 w-8 items-center justify-center rounded-full bg-white border border-slate-200 text-slate-600 transition-all duration-200 hover:bg-indigo-50 hover:border-indigo-200 hover:text-indigo-600" do %>
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <use href="#heroicon-eye" />
                </svg>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <%= render "shared/empty_state",
          icon: "users",
          title: "Nenhum participante ainda",
          description: "Adicione participantes para começar a competição",
          action_text: (@competition.owner == current_user ? "Adicionar primeiro participante" : nil),
          action_url: (@competition.owner == current_user ? new_participant_path(competition_id: @competition.id) : nil) %>
    <% end %>
  </article>

  <!-- Rankings Section -->
  <% if @competition.rankings.any? %>
    <article class="rounded-3xl border border-slate-100 bg-white p-6 shadow-xl">
      <header class="flex items-center justify-between mb-6">
        <div>
          <p class="text-xs uppercase tracking-[0.3em] text-indigo-400">Rankings</p>
          <h2 class="text-2xl font-semibold text-slate-900">Classificações</h2>
        </div>
        <span class="rounded-full bg-indigo-50 px-3 py-1 text-xs font-semibold text-indigo-600">
          <%= @competition.rankings.count %>
        </span>
      </header>

      <div class="space-y-3">
        <% @competition.rankings.order(created_at: :desc).limit(5).each do |ranking| %>
          <div class="rounded-2xl border border-slate-100 bg-slate-50/60 p-4 transition-all duration-200 hover:shadow-md hover:border-slate-200">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-semibold text-slate-900">
                  <%= ranking.participant.name %>
                </p>
                <p class="text-xs text-slate-500">
                  Avaliado por: <%= ranking.user.name %> · <%= l ranking.created_at, format: :short %>
                </p>
              </div>
              <div class="text-right">
                <p class="text-2xl font-bold text-indigo-600"><%= ranking.score %></p>
                <p class="text-xs text-slate-500">pontos</p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if @competition.rankings.count > 5 %>
        <div class="mt-4 text-center">
          <%= link_to "Ver todos os rankings", rankings_path(competition_id: @competition.id), class: "text-sm font-semibold text-indigo-600 hover:text-indigo-500 transition-colors" %>
        </div>
      <% end %>
    </article>
  <% end %>
</div>
