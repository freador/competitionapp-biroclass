<% content_for :title, @competition.title %>

<div class="mx-auto max-w-7xl space-y-10 px-6 py-10">
  <!-- Page Header -->
  <header class="rounded-2xl border-4 border-black bg-white p-10 shadow-2xl">
    <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-[0.3em] text-gray-600">Dashboard da competição</p>
    <h1 class="mt-3 font-['Montserrat'] text-6xl font-bold text-black"><%= @competition.title %></h1>
    <p class="mt-4 text-xl text-gray-700"><%= @competition.description %></p>
  </header>

  <!-- Competition Stats -->
  <div class="grid gap-6 md:grid-cols-3">
    <!-- Status -->
    <div class="rounded-xl border-4 border-black bg-white p-8 shadow-xl transition-all hover:border-[#FFCC00]">
      <div class="flex items-center gap-4">
        <div class="flex h-16 w-16 items-center justify-center rounded-full bg-black">
          <svg class="h-8 w-8 text-[#FFCC00]" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-trophy" />
          </svg>
        </div>
        <div>
          <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-gray-600">Status</p>
          <% status_variant = case @competition.status
              when "active", "ativo", "em_andamento", "open" then "success"
              when "rascunho", "draft" then "warning"
              when "finalizada", "finished", "closed" then "default"
              else "info"
            end %>
          <%= render "shared/badge", text: @competition.status, variant: status_variant, size: "md" %>
        </div>
      </div>
    </div>

    <!-- Participants Count -->
    <div class="rounded-xl border-4 border-black bg-white p-8 shadow-xl transition-all hover:border-[#FFCC00]">
      <div class="flex items-center gap-4">
        <div class="flex h-16 w-16 items-center justify-center rounded-full bg-black">
          <svg class="h-8 w-8 text-[#FFCC00]" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-users" />
          </svg>
        </div>
        <div>
          <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-gray-600">Participantes</p>
          <p class="font-['Montserrat'] text-4xl font-bold text-black"><%= @competition.participants.count %></p>
        </div>
      </div>
    </div>

    <!-- Owner Info -->
    <div class="rounded-xl border-4 border-black bg-white p-8 shadow-xl transition-all hover:border-[#FFCC00]">
      <div class="flex items-center gap-4">
        <div class="flex h-16 w-16 items-center justify-center rounded-full bg-black">
          <svg class="h-8 w-8 text-[#FFCC00]" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-star" />
          </svg>
        </div>
        <div>
          <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-gray-600">Organizador</p>
          <p class="text-lg font-bold text-black"><%= @competition.owner.name %></p>
        </div>
      </div>
    </div>
  </div>

  <!-- Rules Section -->
  <% if @competition.rules.present? %>
    <article class="rounded-2xl border-4 border-black bg-white p-10 shadow-2xl">
      <div class="mb-6 flex items-center gap-3">
        <svg class="h-8 w-8 text-[#FFCC00]" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <use href="#heroicon-document" />
        </svg>
        <h2 class="font-['Montserrat'] text-3xl font-bold text-black">Regras da Competição</h2>
      </div>
      <div class="rounded-xl border-2 border-gray-200 bg-gray-50 p-6 text-base leading-relaxed text-gray-700">
        <%= simple_format(@competition.rules) %>
      </div>
    </article>
  <% end %>

  <!-- Actions -->
  <div class="flex flex-wrap gap-3">
    <% if @competition.owner == current_user %>
      <%= link_to edit_competition_path(@competition), class: "inline-flex items-center gap-2 rounded-full border-2 border-black px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-black transition-all hover:bg-black hover:text-[#FFCC00] active:scale-95" do %>
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <use href="#heroicon-pencil" />
        </svg>
        Editar competição
      <% end %>

      <% if @competition.draft? %>
        <%= button_to start_competition_path(@competition),
            method: :patch,
            disabled: !@competition.ready_to_publish?,
            class: "inline-flex items-center gap-2 rounded-full border-2 border-emerald-600 bg-emerald-50 px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-emerald-700 transition-all hover:bg-emerald-600 hover:text-white active:scale-95 disabled:cursor-not-allowed disabled:opacity-50" do %>
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-trophy" />
          </svg>
          Começar competição
        <% end %>
        <% unless @competition.ready_to_publish? %>
          <p class="w-full text-xs text-gray-600">Cadastre ao menos 1 jurado e 1 participante para iniciar.</p>
        <% end %>
      <% elsif @competition.open? %>
        <%= button_to close_competition_path(@competition),
            method: :patch,
            class: "inline-flex items-center gap-2 rounded-full border-2 border-rose-600 bg-rose-50 px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-rose-700 transition-all hover:bg-rose-600 hover:text-white active:scale-95" do %>
          <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-x" />
          </svg>
          Encerrar competição
        <% end %>
      <% end %>
    <% end %>

    <%= link_to competitions_path, class: "inline-flex items-center gap-2 rounded-full border-2 border-gray-400 px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-gray-700 transition-all hover:border-black hover:bg-gray-50 active:scale-95" do %>
      <svg class="h-4 w-4 rotate-180" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
        <use href="#heroicon-arrow-right" />
      </svg>
      Voltar
    <% end %>

    <% if @competition.accepted_judge?(current_user) && @competition.open? %>
      <%= link_to judging_competition_path(@competition), class: "inline-flex items-center gap-2 rounded-full bg-[#FFCC00] px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-black shadow-lg shadow-[#FFCC00]/20 transition-all hover:scale-105 hover:bg-[#FFD633] active:scale-95" do %>
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <use href="#heroicon-star" />
        </svg>
        Painel de notas
      <% end %>
    <% end %>

    <% if @competition.owner == current_user %>
      <%= button_to competition_path(@competition), method: :delete, form: { data: { turbo_confirm: "Tem certeza que deseja excluir esta competição?" } }, class: "inline-flex items-center gap-2 rounded-full border-2 border-rose-600 bg-rose-50 px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-rose-600 transition-all hover:bg-rose-600 hover:text-white active:scale-95" do %>
        <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
          <use href="#heroicon-trash" />
        </svg>
        Excluir competição
      <% end %>
    <% end %>
  </div>

  <!-- Judge Invites Section -->
  <% if @competition.owner == current_user %>
    <article class="rounded-2xl border-4 border-black bg-white p-10 shadow-2xl">
      <header class="mb-8">
        <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-[0.3em] text-[#FFCC00]">Convites</p>
        <h2 class="mt-2 font-['Montserrat'] text-4xl font-bold text-black">Links para Jurados</h2>
        <p class="mt-4 text-base text-gray-700">Compartilhe os links abaixo apenas com o time de avaliação. Participantes não precisam de convite: basta cadastrá-los pelo nome e as notas aparecerão no painel público em tempo real.</p>
      </header>

      <section>
        <h3 class="font-['Montserrat'] text-lg font-bold uppercase tracking-wide text-black">Jurados</h3>
        <% if @judge_invites&.any? %>
          <ul class="mt-6 space-y-4">
            <% @judge_invites.each do |invite| %>
              <li class="rounded-xl border-2 border-gray-200 bg-gray-50 p-6">
                <p class="font-['Montserrat'] text-lg font-bold text-black"><%= invite.email %></p>
                <p class="mt-1 text-sm text-gray-600">Status: <span class="font-semibold"><%= invite.status %></span></p>
                <div class="mt-4 rounded-lg border-2 border-black bg-white px-4 py-3 font-mono text-sm text-black">
                  <%= invite.invitation_path %>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="mt-6 rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-8 text-center text-gray-600">Nenhum jurado cadastrado nesta competição.</p>
        <% end %>
      </section>
    </article>
  <% end %>

  <!-- Participants Section -->
  <article class="rounded-2xl border-4 border-black bg-white p-10 shadow-2xl">
    <header class="mb-8 flex items-center justify-between">
      <div>
        <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-[0.3em] text-[#FFCC00]">Participantes</p>
        <h2 class="mt-2 font-['Montserrat'] text-4xl font-bold text-black">Lista de Participantes</h2>
      </div>
      <% if @competition.owner == current_user %>
        <%= link_to new_participant_path(competition_id: @competition.id), class: "inline-flex items-center gap-2 rounded-full bg-[#FFCC00] px-6 py-3 font-['Montserrat'] text-xs font-bold uppercase tracking-wide text-black shadow-lg shadow-[#FFCC00]/20 transition-all hover:scale-105 hover:bg-[#FFD633] active:scale-95" do %>
          <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
            <use href="#heroicon-plus" />
          </svg>
          Adicionar participante
        <% end %>
      <% end %>
    </header>

    <% if @competition.participants.any? %>
      <div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        <% @competition.participants.each do |participant| %>
          <div class="group rounded-xl border-2 border-gray-200 bg-gray-50 p-6 transition-all hover:border-[#FFCC00] hover:shadow-lg">
            <div class="flex items-start justify-between">
              <div class="flex-1">
                <h3 class="font-['Montserrat'] text-xl font-bold text-black"><%= participant.name %></h3>
                <% if participant.user.present? %>
                  <p class="mt-1 text-sm text-gray-600">Vinculado: <%= participant.user.name %></p>
                <% end %>
              </div>
              <%= link_to participant_path(participant), class: "flex h-10 w-10 items-center justify-center rounded-full border-2 border-black bg-white text-black transition-all hover:bg-[#FFCC00] hover:border-[#FFCC00]" do %>
                <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                  <use href="#heroicon-eye" />
                </svg>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% else %>
      <%= render "shared/empty_state",
          icon: "users",
          title: "Nenhum participante ainda",
          description: "Adicione participantes para começar a competição",
          action_text: (@competition.owner == current_user ? "Adicionar primeiro participante" : nil),
          action_url: (@competition.owner == current_user ? new_participant_path(competition_id: @competition.id) : nil) %>
    <% end %>
  </article>

  <!-- Rankings Section -->
  <% if @competition.rankings.any? %>
    <article class="rounded-2xl border-4 border-black bg-white p-10 shadow-2xl">
      <header class="mb-8 flex items-center justify-between">
        <div>
          <p class="font-['Montserrat'] text-xs font-bold uppercase tracking-[0.3em] text-[#FFCC00]">Rankings</p>
          <h2 class="mt-2 font-['Montserrat'] text-4xl font-bold text-black">Classificações</h2>
        </div>
        <span class="rounded-full border-2 border-[#FFCC00] bg-[#FFCC00]/10 px-5 py-2 font-['Montserrat'] text-sm font-bold text-[#FFCC00]">
          <%= @competition.rankings.count %>
        </span>
      </header>

      <div class="space-y-4">
        <% @competition.rankings.order(created_at: :desc).limit(5).each do |ranking| %>
          <div class="rounded-xl border-2 border-gray-200 bg-gray-50 p-6 transition-all hover:border-[#FFCC00] hover:shadow-md">
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="font-['Montserrat'] text-xl font-bold text-black">
                  <%= ranking.participant.name %>
                </p>
                <p class="mt-1 text-sm text-gray-600">
                  Avaliado por: <span class="font-semibold"><%= ranking.user.name %></span> · <%= l ranking.created_at, format: :short %>
                </p>
              </div>
              <div class="text-right">
                <p class="font-['Montserrat'] text-5xl font-bold text-[#FFCC00]"><%= ranking.score %></p>
                <p class="mt-1 text-xs uppercase tracking-wide text-gray-600">pontos</p>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <% if @competition.rankings.count > 5 %>
        <div class="mt-8 text-center">
          <%= link_to rankings_path(competition_id: @competition.id), class: "inline-flex items-center gap-2 font-['Montserrat'] text-sm font-bold text-[#FFCC00] transition-colors hover:text-black" do %>
            Ver todos os rankings
            <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
              <use href="#heroicon-arrow-right" />
            </svg>
          <% end %>
        </div>
      <% end %>
    </article>
  <% end %>
</div>
